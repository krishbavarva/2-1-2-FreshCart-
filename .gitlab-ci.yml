stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  BACKEND_DIR: "backend"
  FRONTEND_DIR: "frontend"

cache:
  paths:
    - backend/node_modules/
    - frontend/node_modules/

backend:test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - npm install --legacy-peer-deps || npm install
    - npm test || echo "No tests configured"
  only:
    - branches
  allow_failure: true

frontend:test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd ${FRONTEND_DIR}
    - npm install --legacy-peer-deps || npm install
    - npm test || echo "No tests configured"
  only:
    - branches
  allow_failure: true

backend:lint:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - npm run lint || echo "Linter not configured"
  only:
    - branches
  allow_failure: true

frontend:build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd ${FRONTEND_DIR}
    - npm install --legacy-peer-deps || npm install
    - npm run build
  artifacts:
    paths:
      - ${FRONTEND_DIR}/dist/
    expire_in: 1 week
  only:
    - main
    - master
    - develop

backend:build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - npm install --legacy-peer-deps || npm install
    - node -c app.js
  only:
    - main
    - master
    - develop

deploy:staging:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "Deploying to staging"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop
  when: manual

deploy:production:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "GitHub Deployment Ready"
    - echo "Push to GitHub using git push github main"
  environment:
    name: production
    url: https://github.com
  only:
    - main
    - master
  when: manual
  allow_failure: true

sync:github:
  stage: deploy
  image: alpine/git:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - |
      if [ -z "$GITLAB_USER_EMAIL" ]; then
        git config --global user.email "gitlab-ci@example.com"
      else
        git config --global user.email "$GITLAB_USER_EMAIL"
      fi
    - |
      if [ -z "$GITLAB_USER_NAME" ]; then
        git config --global user.name "GitLab CI"
      else
        git config --global user.name "$GITLAB_USER_NAME"
      fi
  script:
    - echo "Syncing to GitHub"
    - |
      if [ -z "$GITHUB_REPO_URL" ]; then
        echo "GITHUB_REPO_URL not set - skipping GitHub sync"
        echo "Set GITHUB_REPO_URL in GitLab Settings -> CI/CD -> Variables"
        exit 0
      fi
    - |
      if [ -n "$GITHUB_TOKEN" ]; then
        echo "Using HTTPS method with token"
        GITHUB_URL_WITH_TOKEN=$(echo $GITHUB_REPO_URL | sed "s|https://|https://${GITHUB_TOKEN}@|")
        git remote add github $GITHUB_URL_WITH_TOKEN 2>/dev/null || git remote set-url github $GITHUB_URL_WITH_TOKEN
        git push github ${CI_COMMIT_REF_NAME} || echo "GitHub push failed - check credentials"
      fi
    - |
      if [ -n "$GITHUB_SSH_PRIVATE_KEY" ]; then
        echo "Using SSH method"
        mkdir -p ~/.ssh
        echo "$GITHUB_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
        GITHUB_SSH_URL=$(echo $GITHUB_REPO_URL | sed "s|https://github.com/|git@github.com:|" | sed "s|\.git$||").git
        git remote add github $GITHUB_SSH_URL 2>/dev/null || git remote set-url github $GITHUB_SSH_URL
        git push github ${CI_COMMIT_REF_NAME} || echo "GitHub SSH push failed - check credentials"
      fi
    - |
      if [ -z "$GITHUB_TOKEN" ] && [ -z "$GITHUB_SSH_PRIVATE_KEY" ]; then
        echo "No GitHub credentials found"
        echo "Set either GITHUB_TOKEN or GITHUB_SSH_PRIVATE_KEY in GitLab Settings -> CI/CD -> Variables"
        exit 0
      fi
    - echo "GitHub sync completed"
  only:
    - main
    - master
  when: on_success
  allow_failure: true

deploy:github:info:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "GitHub Deployment Information"
    - echo "Setup GitHub sync in GitLab Settings"
  only:
    - main
    - master
  when: manual
  allow_failure: true
