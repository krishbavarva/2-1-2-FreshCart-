# GitLab CI/CD Pipeline Configuration
# This pipeline runs tests and deploys both frontend and backend

stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  BACKEND_DIR: "backend"
  FRONTEND_DIR: "frontend"

# Cache node_modules for faster builds
cache:
  paths:
    - backend/node_modules/
    - frontend/node_modules/

# Backend Tests
backend:test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - echo "Installing backend dependencies..."
    - npm install --legacy-peer-deps || npm install
    - echo "Running backend tests..."
    - npm test 2>&1 || echo "No tests configured yet - skipping"
  only:
    - branches
    - merge_requests
  allow_failure: true

# Frontend Tests
frontend:test:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd ${FRONTEND_DIR}
    - echo "Installing frontend dependencies..."
    - npm install --legacy-peer-deps || npm install
    - echo "Running frontend tests..."
    - npm test 2>&1 || echo "No tests configured yet - skipping"
  only:
    - branches
    - merge_requests
  allow_failure: true

# Backend Lint Check
backend:lint:
  stage: test
  image: node:${NODE_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - echo "Checking backend code quality..."
    - npm run lint 2>&1 || echo "Linter not configured - skipping"
  only:
    - branches
    - merge_requests
  allow_failure: true

# Frontend Build
frontend:build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd ${FRONTEND_DIR}
    - echo "Installing frontend dependencies..."
    - npm install --legacy-peer-deps || npm install
    - echo "Building frontend..."
    - npm run build || (echo "âš ï¸ Build failed - check for errors above" && exit 1)
    - echo "âœ… Frontend build completed successfully!"
  artifacts:
    paths:
      - ${FRONTEND_DIR}/dist/
    expire_in: 1 week
  only:
    - main
    - master
    - develop
  allow_failure: false

# Backend Build Check
backend:build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - cd ${BACKEND_DIR}
    - echo "Installing backend dependencies..."
    - npm install --legacy-peer-deps || npm install
    - echo "Checking backend build..."
    - node -c app.js || (echo "âš ï¸ Syntax error in app.js" && exit 1)
    - echo "âœ… Backend syntax check passed"
    - echo "âœ… Backend build check completed!"
  only:
    - main
    - master
    - develop
  allow_failure: false

# Deploy to staging
deploy:staging:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸš€ Deploying to staging environment..."
    - echo "Backend deployment..."
    - cd ${BACKEND_DIR}
    - echo "âœ… Backend ready for deployment"
    - echo "Frontend deployment..."
    - cd ../${FRONTEND_DIR}
    - echo "âœ… Frontend ready for deployment"
    - echo "âœ… Staging deployment completed!"
  environment:
    name: staging
    url: https://staging.example.com
  only:
    - develop
  when: manual

# Deploy to production (GitHub Pages)
deploy:production:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸš€ GitHub Deployment Ready!"
    - echo "ğŸ“ This project uses GitHub Actions for deployment"
    - echo ""
    - echo "âœ… To deploy to GitHub Pages:"
    - echo "   1. Push to GitHub: git push github main"
    - echo "   2. GitHub Actions will automatically:"
    - echo "      - Run all tests"
    - echo "      - Build frontend"
    - echo "      - Deploy to GitHub Pages"
    - echo ""
    - echo "ğŸŒ Your site will be live at:"
    - echo "   https://yourusername.github.io/your-repo-name/"
    - echo ""
    - echo "ğŸ“‹ See GITHUB_DEPLOYMENT.md for detailed instructions"
  environment:
    name: production
    url: https://github.com
  only:
    - main
    - master
  when: manual
  allow_failure: true

# Auto-sync to GitHub (pushes to GitHub automatically when you push to GitLab)
sync:github:
  stage: deploy
  image: alpine/git:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - |
      if [ -z "$GITLAB_USER_EMAIL" ]; then
        git config --global user.email "gitlab-ci@example.com"
      else
        git config --global user.email "$GITLAB_USER_EMAIL"
      fi
    - |
      if [ -z "$GITLAB_USER_NAME" ]; then
        git config --global user.name "GitLab CI"
      else
        git config --global user.name "$GITLAB_USER_NAME"
      fi
  script:
    - echo "ğŸ”„ Syncing to GitHub..."
    - |
      if [ -z "$GITHUB_REPO_URL" ]; then
        echo "âš ï¸ GITHUB_REPO_URL not set - skipping GitHub sync"
        echo "ğŸ“ Set GITHUB_REPO_URL in GitLab: Settings â†’ CI/CD â†’ Variables"
        echo "ğŸ“– See GITLAB_TO_GITHUB_SYNC.md for setup instructions"
        exit 0
      fi
    - |
      # Method 1: Try HTTPS with token (easier - recommended)
      if [ -n "$GITHUB_TOKEN" ]; then
        echo "ğŸ” Using HTTPS method with token..."
        GITHUB_URL_WITH_TOKEN=$(echo $GITHUB_REPO_URL | sed "s|https://|https://${GITHUB_TOKEN}@|")
        git remote add github $GITHUB_URL_WITH_TOKEN 2>/dev/null || git remote set-url github $GITHUB_URL_WITH_TOKEN
        git push github ${CI_COMMIT_REF_NAME} && echo "âœ… HTTPS push successful!" || echo "âš ï¸ HTTPS push failed"
      fi
    - |
      # Method 2: Try SSH (if HTTPS failed or SSH key provided)
      if [ -n "$GITHUB_SSH_PRIVATE_KEY" ]; then
        echo "ğŸ” Using SSH method..."
        mkdir -p ~/.ssh
        echo "$GITHUB_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
        GITHUB_SSH_URL=$(echo $GITHUB_REPO_URL | sed "s|https://github.com/|git@github.com:|" | sed "s|\.git$||").git
        git remote add github $GITHUB_SSH_URL 2>/dev/null || git remote set-url github $GITHUB_SSH_URL
        git push github ${CI_COMMIT_REF_NAME} && echo "âœ… SSH push successful!" || echo "âš ï¸ SSH push failed"
      fi
    - |
      # Check if sync was successful
      if [ -z "$GITHUB_TOKEN" ] && [ -z "$GITHUB_SSH_PRIVATE_KEY" ]; then
        echo "âš ï¸ No GitHub credentials found"
        echo "ğŸ“ Please set either GITHUB_TOKEN or GITHUB_SSH_PRIVATE_KEY"
        echo "ğŸ“– See GITLAB_TO_GITHUB_SYNC.md for instructions"
        exit 0
      fi
    - echo "âœ… Successfully synced to GitHub!"
    - echo "ğŸŒ GitHub Actions will now run automatically"
    - |
      if [ -n "$GITHUB_REPO_URL" ]; then
        REPO_NAME=$(echo $GITHUB_REPO_URL | sed 's|.*github.com/||' | sed 's|\.git$||')
        echo "ğŸ“‹ Check GitHub Actions: https://github.com/$REPO_NAME/actions"
      fi
  only:
    - main
    - master
  when: on_success
  allow_failure: true

# GitHub Deployment Info
deploy:github:info:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "ğŸš€ GitHub Deployment Information"
    - echo "ğŸ“ Your project is configured for GitHub deployment!"
    - echo ""
    - echo "âœ… Auto-sync enabled: Code pushed to GitLab will auto-sync to GitHub"
    - echo "âœ… GitHub Actions CI/CD is set up in .github/workflows/"
    - echo "   - ci-cd.yml: Runs tests and builds"
    - echo "   - pages.yml: Deploys frontend to GitHub Pages"
    - echo ""
    - echo "ğŸ“‹ Setup GitHub sync:"
    - echo "   1. Go to GitLab: Settings â†’ CI/CD â†’ Variables"
    - echo "   2. Add variable: GITHUB_REPO_URL = https://github.com/username/repo.git"
    - echo "   3. Add variable: GITHUB_SSH_PRIVATE_KEY = (your GitHub SSH private key)"
    - echo ""
    - echo "ğŸŒ After sync, GitHub Actions will deploy automatically!"
    - echo "   Frontend: https://yourusername.github.io/your-repo-name/"
  only:
    - main
    - master
  when: manual
  allow_failure: true
